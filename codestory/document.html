<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CodeStory</title>
  <meta name="description" content="CodeStory">
  <meta name="author" content=CodeStory>
  <link rel="stylesheet" href="static/bullets.css">
  <link rel="stylesheet" href="static/prism.css">
</head>
<body>
<h1>Index</h1>
<ol>
<li><a href="#HOW_TO_REGISTER_PASS_LEGACY">How is a pass registered? (Legacy PM)</a></li>
</ol>
<p><a name='HOW_TO_REGISTER_PASS_LEGACY'></a></p>
<h2>How is a pass registered? (Legacy PM)</h2>
<p>We create an object of the <code>RegisterPass</code> class template,
from the file defining our pass.
The template is instantiated to the <code>Hello</code> pass we want
registered here. The two arguments to the constructer
are the:</p>
<ol>
<li>First: A command line argument needed to invoke the pass (<code>-hello</code> in this case)</li>
<li>Second: A short meaningful description for the users of the pass.</li>
</ol>
<p>The name <code>X</code> is itself not used anywhere (although the object created is).</p>
<p><a href="file:///home/codeman/.itsoflife/mydata/git/ws/codestory-git/sample/Hello.cpp">Hello.cpp</a></p>
<pre class='language-cpp line-numbers' data-start='52'><code>
    static RegisterPass<Hello> X("hello", "Hello World Pass");
</code></pre>
<h3></h3>
<p>The constructor of <code>RegisterPass</code> calls the <code>PassRegistry::getPassRegistry()-&gt;registerPass()</code>
method to register the pass with the <code>PassRegistry</code>.</p>
<p>Note that <code>RegisterPass</code> is a subclass of <code>PassInfo</code> class.</p>
<p>The <code>RegisterPass</code> constructor takes four arguments:</p>
<ol>
<li><code>StringRef PassArg</code>: the command line name of the argument (like <code>-hello</code>)</li>
<li><code>StringRef Name</code>: a short meaningful description of the pass</li>
<li><code>bool CFGOnly</code>: ??</li>
<li><code>bool is_analysis</code>: Is this pass just an analysis pass?</li>
</ol>
<p><a href="file:///home/codeman/.itsoflife/mydata/git/ws/codestory-git/sample/PassSupport.h">PassSupport.h</a></p>
<pre class='language-cpp line-numbers' data-start='95'><code>
    //===---------------------------------------------------------------------------
    /// RegisterPass<t> template - This template class is used to notify the system
    /// that a Pass is available for use, and registers it into the internal
    /// database maintained by the PassManager.  Unless this template is used, opt,
    /// for example will not be able to see the pass and attempts to create the pass
    /// will fail. This template is used in the follow manner (at global scope, in
    /// your .cpp file):
    ///
    /// static RegisterPass<YourPassClassName> tmp("passopt", "My Pass Name");
    ///
    /// This statement will cause your pass to be created by calling the default
    /// constructor exposed by the pass.
    template <typename passName> struct RegisterPass : public PassInfo {
      // Register Pass using default constructor...
      RegisterPass(StringRef PassArg, StringRef Name, bool CFGOnly = false,
                   bool is_analysis = false)
          : PassInfo(Name, PassArg, &passName::ID,
                     PassInfo::NormalCtor_t(callDefaultCtor<passName>), CFGOnly,
                     is_analysis) {
        PassRegistry::getPassRegistry()->registerPass(*this);
      }
    };
</code></pre>
<h3></h3>
<p>Looking at the constructor definition closely,
notice how <code>&amp;passName::ID</code> is used to steal the address
of the <code>ID</code> variable defined in the pass class.
This address is used as an identifier of the analysis
at various places in LLVM.</p>
<p>In order for LLVM to create instances of the pass,
<code>PassInfo::NormalCtor_t(callDefaultCtor&lt;passName&gt;)</code> is used,
which effectively stores a pointer to a function that can
return new object of the pass. <code>callDefaultCtor&lt;passName&gt;</code>
is actually that function's name.</p>
<p><a href="file:///home/codeman/.itsoflife/mydata/git/ws/codestory-git/sample/PassSupport.h">PassSupport.h</a></p>
<pre class='language-cpp line-numbers' data-start='124'><code>
          : PassInfo(Name, PassArg, &passName::ID,
                     PassInfo::NormalCtor_t(callDefaultCtor<passName>), CFGOnly,
                     is_analysis) {
        PassRegistry::getPassRegistry()->registerPass(*this);
      }
</code></pre>
<h3></h3>
<p>Below is the definition of the <code>callDefaultCtor()</code> function.</p>
<p><a href="file:///home/codeman/.itsoflife/mydata/git/ws/codestory-git/sample/PassSupport.h">PassSupport.h</a></p>
<pre class='language-cpp line-numbers' data-start='80'><code>
    template <typename PassName> Pass *callDefaultCtor() { return new PassName(); }
</code></pre>
<br/> <br/>
  <script src="static/prism.js"></script>
</body>
</html>
